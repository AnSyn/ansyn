os: linux
dist: focal
addons:
  chrome: stable

language: node_js

node_js:
  - lts/*

services:
  - docker
  - xvfb

install:
  - npm set progress=false
  - npm ci

script:
  - npm run lint || travis_terminate 1;
  - npm run test:single-run || travis_terminate 1;
  - npm run build:libs || travis_terminate 1;
  - sh -x scripts/build.sh ansyn $TRAVIS_COMMIT $TRAVIS_TAG || travis_terminate 1;

cache: npm

before_deploy:
  - docker --version
  - pip install --user awscli # install aws cli w/o sudo
  - export PATH=$PATH:$HOME/.local/bin # put aws in the path

deploy:
  - provider: script
    script: sh -x scripts/deploy.sh $REPO_DEV $TRAVIS_COMMIT $CLUSTER $SERVICES_DEV
    on:
      branch: master
  - provider: script
    script: sh -x scripts/deploy.sh $REPO_PROD $TRAVIS_TAG $CLUSTER $SERVICES_PROD
    on:
      tags: true

notifications:
  email: false
